<!doctype html>
<html lang="en" data-theme="forest">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ThreadlessCoin</title>

<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  base-uri 'none';
  form-action 'self';
  img-src 'self' data:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' https://cdn.jsdelivr.net https://cdn.skypack.dev 'unsafe-inline';
  connect-src 'self' https://*.supabase.co wss://*.supabase.co;
  upgrade-insecure-requests;">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="robots" content="noindex, nofollow">

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230e1613'/%3E%3Ccircle cx='32' cy='32' r='26' fill='none' stroke='%23ff8b3d' stroke-width='4'/%3E%3Cpath d='M20 22h24M20 32h24M20 42h24' stroke='%23ff8b3d' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E">

<style>
:root{
  --bg:#0e1613; --card:#122019; --ink:#e9f5ee; --muted:#9db7ab; --line:#1e2e27;
  --accent:#ff8b3d; --accent-2:#1f9d68; --accent-2-ink:#06120d; --warn:#ffd08f;
  --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}
[data-theme="forest"]{ --bg:#0e1613; --card:#122019; --ink:#e9f5ee; --muted:#9db7ab; --line:#1e2e27; --accent:#ff8b3d; --accent-2:#1f9d68; --accent-2-ink:#06120d; --warn:#ffd08f }
[data-theme="sunset"]{ --bg:#160f12; --card:#22161b; --ink:#ffeef3; --muted:#c5a7b3; --line:#2d1e25; --accent:#ff6b6b; --accent-2:#ffb86b; --accent-2-ink:#2b130f; --warn:#ffe0b5 }
[data-theme="midnight"]{ --bg:#0d0f19; --card:#121427; --ink:#e9ebff; --muted:#a9b0d4; --line:#1a1d36; --accent:#8ab4ff; --accent-2:#6ae6c1; --accent-2-ink:#021410; --warn:#ffd9a3 }
[data-theme="ocean"]{ --bg:#07171d; --card:#0d2330; --ink:#e6fbff; --muted:#a6c9d6; --line:#143244; --accent:#26b0ff; --accent-2:#15d1b2; --accent-2-ink:#01221c; --warn:#ffe6b8 }
[data-theme="grape"]{ --bg:#160d1a; --card:#231128; --ink:#f6e9ff; --muted:#c7abd8; --line:#31153b; --accent:#c47dff; --accent-2:#ff9fb3; --accent-2-ink:#2b0c18; --warn:#ffe0c1 }
[data-theme="mono"]{ --bg:#0c0c0c; --card:#141414; --ink:#f5f5f5; --muted:#bcbcbc; --line:#202020; --accent:#ffffff; --accent-2:#d0d0d0; --accent-2-ink:#121212 }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 20% -10%, color-mix(in srgb, var(--card) 60%, transparent) 0%, transparent 60%),
    radial-gradient(1000px 800px at 120% -20%, color-mix(in srgb, var(--card) 60%, transparent) 0%, transparent 55%),
    var(--bg);
  color:var(--ink);
  font:16px/1.5 var(--font);
}
header{
  position:sticky; top:0; z-index:3;
  background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent);
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
  border-bottom:1px solid var(--line);
}
.wrap{max-width:860px;margin:0 auto;padding:16px}
.topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
.brand{display:flex; align-items:center; gap:12px}
h1{margin:0 0 4px; font-size:22px}
.sub{color:var(--muted); font-size:13px}
.theme-switch{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px }
.theme-select{ appearance:none; border:1px solid var(--line); background:var(--card); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer }
.card{ margin:16px 0; padding:16px; background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
.btn{ border:0; border-radius:12px; padding:10px 14px; background:linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 75%, #000 25%)); color:#28150a; font-weight:800; cursor:pointer; box-shadow: 0 6px 18px color-mix(in srgb, var(--accent) 25%, transparent), inset 0 1px 0 rgba(255,255,255,.15) }
.btn[disabled]{opacity:.55; cursor:not-allowed}
.meta{color:var(--muted); font-size:12px}

.logo{ width:32px;height:32px;border-radius:10px;background:var(--bg);border:1px solid var(--line); display:grid; place-items:center; position:relative }
.logo::before{ content:''; position:absolute; inset:2px; border-radius:10px; border:2px solid var(--accent); opacity:.9; }
.logo::after{ content:''; width:24px; height:6px; border-radius:6px; background:var(--accent); box-shadow:0 12px 0 var(--accent), 0 24px 0 var(--accent); transform:translateY(-6px) }

.balance{ font-size:20px; font-weight:800; margin-top:8px }
.label{ color:var(--muted); font-size:12px }

.progress-wrap{ margin-top:12px }
progress{ width:100%; height:20px; -webkit-appearance:none; appearance:none }
progress::-webkit-progress-bar{ background: color-mix(in srgb, var(--bg) 90%, black 10%); border:1px solid color-mix(in srgb, var(--line) 75%, black 25%); border-radius:12px }
progress::-webkit-progress-value{ background: var(--accent); border-radius:12px }
progress::-moz-progress-bar{ background: var(--accent); border-radius:12px }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ThreadlessCoin</h1>
          <div class="sub">A tiny, fun coin demo · 1,000,000 max supply</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="theme-switch">
          Theme:
          <select id="theme" class="theme-select" aria-label="Select theme">
            <option value="forest">Forest</option>
            <option value="sunset">Sunset</option>
            <option value="midnight">Midnight</option>
            <option value="ocean">Ocean</option>
            <option value="grape">Grape</option>
            <option value="mono">Mono</option>
          </select>
        </div>
        <span class="meta" id="status">signed out</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Account -->
  <section class="card">
    <h2 style="margin:0 0 8px">Account</h2>

    <div id="authArea">
      <button class="btn" id="signInBtn">Sign in / Sign up via email</button>
      <span class="meta">We’ll send a magic link.</span>
    </div>

    <div id="userArea" style="display:none">
      <div class="label">Signed in as</div>
      <div><strong id="userEmail"></strong> • <span id="userName" class="meta"></span></div>

      <div class="balance"><span id="userBalance">0.0000</span> TCOIN</div>

      <div id="nameEditor" style="margin-top:10px; display:none">
        <input id="nameInput" placeholder="choose a username" style="padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink)"/>
        <button class="btn" id="saveNameBtn">Save</button>
      </div>

      <div style="margin-top:10px">
        <button class="btn" id="editNameBtn">Set / change username</button>
        <button class="btn" id="signOutBtn">Sign out</button>
      </div>
    </div>
  </section>

  <!-- Mining -->
  <section class="card">
    <h2 style="margin:0 0 8px">Mine ThreadlessCoin</h2>
    <div class="meta">Your browser solves a small proof-of-work. Valid solutions are verified by the server and credited to your balance.</div>
    <div class="progress-wrap">
      <progress id="miningProgress" value="0" max="100"></progress>
      <div id="progressLabel" class="meta" style="margin-top:4px">Idle</div>
    </div>
    <div style="display:flex; gap:8px; margin-top:10px">
      <button class="btn" id="mineBtn" disabled>Start mining</button>
      <button class="btn" id="stopBtn" disabled>Stop</button>
    </div>
    <div class="meta" id="mineMeta" style="margin-top:8px">Solved: 0 • Pending: 0</div>
  </section>

  <!-- Send / Receive (left as demo wiring for now) -->
  <section class="card">
    <h2 style="margin:0 0 8px">Send / Receive</h2>
    <div class="meta" style="margin-bottom:10px">Add a friend by username, then send them TCOIN.</div>
    <div style="display:flex; flex-wrap:wrap; gap:8px">
      <input id="friend" placeholder="friend username" style="flex:1; min-width:220px; padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink)" />
      <input id="amount" type="number" min="0" step="0.0001" placeholder="amount" style="width:140px; padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink)"/>
      <button class="btn" id="sendBtn">Send</button>
    </div>
    <div class="meta" id="sendMsg" style="margin-top:8px"></div>
  </section>

  <footer class="meta" style="text-align:center;margin:36px 0">© 2025 ThreadlessCoin</footer>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
'use strict';

/* ====== CONFIG (yours) ====== */
const TC = {
  SUPABASE_URL:  "https://vgdskvrovkekoxkixzsh.supabase.co",
  SUPABASE_ANON: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnZHNrdnJvdmtla294a2l4enNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NzIwOTYsImV4cCI6MjA3NDA0ODA5Nn0.e_wcEufQiUQpVwyAcshfOOdwf48gGzP8RiFOu5GYYmo",
  sb: null,
};

/* ====== THEME ====== */
(function setupTheme(){
  const sel = document.getElementById('theme');
  const saved = localStorage.getItem('threadless_theme') || 'forest';
  document.documentElement.setAttribute('data-theme', saved);
  sel.value = saved;
  sel.addEventListener('change', ()=>{
    const v = sel.value;
    document.documentElement.setAttribute('data-theme', v);
    localStorage.setItem('threadless_theme', v);
  });
})();

/* ====== HELPERS ====== */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=>Number(n||0).toFixed(4);

/* ====== AUTH / PROFILE ====== */
(async function boot(){
  const status = $('status');
  const authArea = $('authArea');
  const userArea = $('userArea');
  const userEmail = $('userEmail');
  const userName = $('userName');
  const userBalance = $('userBalance');
  const mineBtn = $('mineBtn'), stopBtn=$('stopBtn');

  function setStatus(s){ status.textContent = s; }
  function showSignedIn(email){ authArea.style.display='none'; userArea.style.display=''; userEmail.textContent=email||''; mineBtn.disabled=false; stopBtn.disabled=true; setStatus('online'); }
  function showSignedOut(){ authArea.style.display=''; userArea.style.display='none'; mineBtn.disabled=true; stopBtn.disabled=true; setStatus('signed out'); }

  TC.sb = supabase.createClient(TC.SUPABASE_URL, TC.SUPABASE_ANON);

  async function loadProfile(){
    const { data, error } = await TC.sb.from('profiles').select('username,balance').single();
    if (error){ console.warn('profile load', error); return; }
    userName.textContent = data.username ? '@'+data.username : '(no username yet)';
    userBalance.textContent = fmt(data.balance);
    // Prompt username if missing
    $('nameEditor').style.display = data.username ? 'none':'';
  }

  // auth state watcher
  TC.sb.auth.onAuthStateChange(async (_evt, session)=>{
    if (session?.user){ showSignedIn(session.user.email); await ensureProfile(); await loadProfile(); }
    else showSignedOut();
  });

  // initial
  const ures = await TC.sb.auth.getUser();
  if (ures.data?.user){ showSignedIn(ures.data.user.email); await ensureProfile(); await loadProfile(); }
  else showSignedOut();

  // email sign-in
  $('signInBtn').addEventListener('click', async ()=>{
    const email = prompt('Enter your email for a magic link:');
    if (!email) return;
    const redirectTo = new URL('./auth.html', location.href).href;
    const { error } = await TC.sb.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectTo }});
    alert(error ? ('Failed: '+(error.message||'error')) : 'Check your email!');
  });

  $('signOutBtn').addEventListener('click', async ()=>{ await TC.sb.auth.signOut(); showSignedOut(); });

  $('editNameBtn').addEventListener('click', ()=>{
    const ed = $('nameEditor'); ed.style.display = ed.style.display ? '' : '';
  });

  $('saveNameBtn').addEventListener('click', async ()=>{
    const raw = ($('nameInput').value||'').trim();
    if (!raw) return;
    const { data, error } = await TC.sb.rpc('set_username', { new_username: raw });
    if (error) { alert(error.message); return; }
    $('nameInput').value = '';
    await loadProfile();
  });

  async function ensureProfile(){
    // Selecting your row will 404 until trigger inserted it—keep calling until exists.
    let tries=0;
    while(tries<3){
      const r = await TC.sb.from('profiles').select('id').single();
      if (!r.error) return;
      await new Promise(r=>setTimeout(r, 300));
      tries++;
    }
  }

  // expose for mining refresh
  window._tcReloadProfile = loadProfile;
})();

/* ====== MINING (server-verified) ====== */
(function mining(){
  const mineBtn = $('mineBtn'), stopBtn=$('stopBtn');
  const bar=$('miningProgress'), label=$('progressLabel'), meta=$('mineMeta');
  let running=false, solved=0, pending=0;

  function updateMeta(){ meta.textContent = `Solved: ${solved} • Pending: ${pending}`; }

  async function sha256Hex(s){
    const buf = new TextEncoder().encode(s);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function getChallenge(){
    const { data, error } = await TC.sb.rpc('get_challenge', { difficulty: 3 });
    if (error) throw error;
    return data; // { id, seed, difficulty }
  }

  async function submitSolution(id, nonce){
    const { data, error } = await TC.sb.rpc('submit_mining_solution', { challenge_id: id, nonce });
    if (error) throw error;
    return data; // reward numeric
  }

  async function mineOnce(){
    const ch = await getChallenge();
    // find nonce such that sha256(seed||nonce) has difficulty leading hex zeros
    const target = '0'.repeat(ch.difficulty);
    label.textContent = `Working (difficulty ${ch.difficulty})…`;
    pending++; updateMeta();

    let found = null;
    bar.value = 0;
    let attempts = 0;
    const step = 1500; // attempts per slice
    while(running){
      for (let i=0;i<step;i++){
        attempts++;
        const nonce = Math.random().toString(36).slice(2) + Date.now().toString(36);
        // eslint-disable-next-line no-await-in-loop
        const h = await sha256Hex(ch.seed + nonce);
        if (h.startsWith(target)){ found = nonce; break; }
      }
      bar.value = Math.min(100, Math.floor(Math.log10(1+attempts)*25)); // smooth-ish
      if (found) break;
      // yield to UI
      // eslint-disable-next-line no-await-in-loop
      await new Promise(r=>setTimeout(r, 0));
    }
    if (!running){ pending--; updateMeta(); label.textContent='Stopped'; return; }

    // claim on server
    try{
      const reward = await submitSolution(ch.id, found);
      solved++; pending--; updateMeta();
      label.textContent = `Proof found! +${reward.toFixed(4)} TCOIN`;
      await window._tcReloadProfile?.();
    }catch(e){
      pending--; updateMeta();
      label.textContent = 'Submit failed: ' + (e.message||'error');
    }
  }

  mineBtn.addEventListener('click', async ()=>{
    if (running) return;
    running = true;
    mineBtn.disabled = true; stopBtn.disabled = false;
    while(running){ await mineOnce(); if (running) await new Promise(r=>setTimeout(r, 400)); }
  });

  stopBtn.addEventListener('click', ()=>{
    running=false; mineBtn.disabled=false; stopBtn.disabled=true; label.textContent='Idle';
  });
})();
</script>
</body>
</html>
