<!doctype html>
<html lang="en" data-theme="forest">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ThreadlessCoin</title>

<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  base-uri 'none';
  form-action 'self';
  img-src 'self' data:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' https://cdn.jsdelivr.net https://cdn.skypack.dev 'unsafe-inline';
  connect-src 'self' https://*.supabase.co wss://*.supabase.co;
  upgrade-insecure-requests;">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="robots" content="noindex, nofollow">

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230e1613'/%3E%3Ccircle cx='32' cy='32' r='26' fill='none' stroke='%23ff8b3d' stroke-width='4'/%3E%3Cpath d='M20 22h24M20 32h24M20 42h24' stroke='%23ff8b3d' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E">

<style>
:root{
  --bg:#0e1613; --card:#122019; --ink:#e9f5ee; --muted:#9db7ab; --line:#1e2e27;
  --accent:#ff8b3d; --accent-2:#1f9d68; --accent-2-ink:#06120d; --warn:#ffd08f;
  --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
[data-theme="forest"]{ --bg:#0e1613; --card:#122019; --ink:#e9f5ee; --muted:#9db7ab; --line:#1e2e27; --accent:#ff8b3d; --accent-2:#1f9d68; --accent-2-ink:#06120d; --warn:#ffd08f }
[data-theme="sunset"]{ --bg:#160f12; --card:#22161b; --ink:#ffeef3; --muted:#c5a7b3; --line:#2d1e25; --accent:#ff6b6b; --accent-2:#ffb86b; --accent-2-ink:#2b130f; --warn:#ffe0b5 }
[data-theme="midnight"]{ --bg:#0d0f19; --card:#121427; --ink:#e9ebff; --muted:#a9b0d4; --line:#1a1d36; --accent:#8ab4ff; --accent-2:#6ae6c1; --accent-2-ink:#021410; --warn:#ffd9a3 }
[data-theme="ocean"]{ --bg:#07171d; --card:#0d2330; --ink:#e6fbff; --muted:#a6c9d6; --line:#143244; --accent:#26b0ff; --accent-2:#15d1b2; --accent-2-ink:#01221c; --warn:#ffe6b8 }
[data-theme="grape"]{ --bg:#160d1a; --card:#231128; --ink:#f6e9ff; --muted:#c7abd8; --line:#31153b; --accent:#c47dff; --accent-2:#ff9fb3; --accent-2-ink:#2b0c18; --warn:#ffe0c1 }
[data-theme="mono"]{ --bg:#0c0c0c; --card:#141414; --ink:#f5f5f5; --muted:#bcbcbc; --line:#202020; --accent:#ffffff; --accent-2:#d0d0d0; --accent-2-ink:#121212; --warn:#ffd08f }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 20% -10%, color-mix(in srgb, var(--card) 60%, transparent) 0%, transparent 60%),
    radial-gradient(1000px 800px at 120% -20%, color-mix(in srgb, var(--card) 60%, transparent) 0%, transparent 55%),
    var(--bg);
  color:var(--ink);
  font:16px/1.5 var(--font);
}
header{ position:sticky; top:0; z-index:3; background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent); backdrop-filter: blur(6px); border-bottom:1px solid var(--line) }
.wrap{max-width:860px;margin:0 auto;padding:16px}
h1{margin:0 0 4px; font-size:22px; letter-spacing:.2px}
.sub{color:var(--muted);font-size:13px}
.topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
.brand{display:flex; align-items:center; gap:12px}
.logo{ width:32px;height:32px;border-radius:10px;background:var(--bg);border:1px solid var(--line); display:grid; place-items:center; position:relative }
.logo::before{ content:''; position:absolute; inset:2px; border-radius:10px; border:2px solid var(--accent); opacity:.9 }
.logo::after{ content:''; display:block; width:24px; height:6px; border-radius:6px; background:var(--accent); box-shadow:0 12px 0 var(--accent), 0 24px 0 var(--accent); transform:translateY(-6px) }

.btn{ border:0; border-radius:12px; padding:10px 14px; background:linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 75%, #000 25%)); color: #28150a; font-weight:800; cursor:pointer; box-shadow: 0 6px 18px color-mix(in srgb, var(--accent) 25%, transparent), inset 0 1px 0 rgba(255,255,255,.15) }
.btn[disabled]{opacity:.55; cursor:not-allowed}

.theme-switch{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px }
.theme-select{ appearance:none; border:1px solid var(--line); background:var(--card); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer }

.card{ margin:16px 0; padding:16px; background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
.meta{color:var(--muted); font-size:12px}

.balance-badge{
  display:inline-flex; align-items:center; gap:8px;
  font: 800 18px/1 var(--font);
  color: var(--accent-2-ink);
  background: linear-gradient(180deg, var(--accent-2), color-mix(in srgb, var(--accent-2) 75%, #000 0%));
  border:1px solid color-mix(in srgb, var(--accent-2) 65%, black);
  border-radius: 999px;
  padding: 8px 12px;
  box-shadow: 0 6px 18px color-mix(in srgb, var(--accent-2) 25%, transparent), inset 0 1px 0 rgba(255,255,255,.12);
}
.username-row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap }
.username-input{
  padding:10px; border-radius:10px; border:1px solid var(--line);
  background:var(--card); color:var(--ink); min-width:220px;
}

/* Mining progress */
.progress-wrap{ margin-top:12px }
progress{ width:100%; height:20px; -webkit-appearance: none; appearance: none; }
progress::-webkit-progress-bar{ background: color-mix(in srgb, var(--bg) 90%, black 10%); border:1px solid color-mix(in srgb, var(--line) 75%, black 25%); border-radius:12px }
progress::-webkit-progress-value{ background: var(--accent); border-radius:12px }
progress::-moz-progress-bar{ background: var(--accent); border-radius:12px }

@media (max-width: 720px){ .wrap{ padding:12px; } .topbar{ flex-wrap:wrap } }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>ThreadlessCoin</h1>
            <div class="sub">A tiny, fun coin demo · 1,000,000 max supply</div>
          </div>
        </div>

        <div style="display:flex; align-items:center; gap:10px;">
          <div class="theme-switch">
            Theme:
            <select id="theme" class="theme-select" aria-label="Select theme">
              <option value="forest">Forest</option>
              <option value="sunset">Sunset</option>
              <option value="midnight">Midnight</option>
              <option value="ocean">Ocean</option>
              <option value="grape">Grape</option>
              <option value="mono">Mono</option>
            </select>
          </div>
          <span class="meta" id="status">connecting…</span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Account -->
    <section class="card">
      <h2 style="margin:0 0 8px">Account</h2>

      <div id="authArea">
        <button class="btn" id="signInBtn">Sign in / Sign up via email</button>
        <span class="meta">We’ll send a magic link.</span>
      </div>

      <div id="userArea" style="display:none">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
          <div>
            <div class="meta" id="userEmail">you@example.com</div>
            <div class="meta" id="userNameLine">username: <strong id="userName">—</strong></div>
          </div>
          <div class="balance-badge" id="balanceBadge">Balance: 0 TCOIN</div>
        </div>

        <div class="username-row" id="usernameEditRow" style="display:none">
          <input id="usernameInput" class="username-input" placeholder="pick a username (a–z, 0–9, _)" />
          <button class="btn" id="saveUserBtn">Save username</button>
          <span class="meta" id="userMsg"></span>
        </div>

        <div style="margin-top:10px">
          <button class="btn" id="signOutBtn">Sign out</button>
        </div>
      </div>
    </section>

    <!-- Mining -->
    <section class="card">
      <h2 style="margin:0 0 8px">Mine ThreadlessCoin</h2>
      <div class="meta">Your browser crunches a tiny puzzle; correct proofs reward a few coins.</div>
      <div class="progress-wrap">
        <progress id="miningProgress" value="0" max="100"></progress>
        <div id="progressLabel" class="meta" style="margin-top:4px">Idle</div>
      </div>
      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn" id="mineBtn">Start mining</button>
        <button class="btn" id="stopBtn" disabled>Stop</button>
      </div>
      <div class="meta" id="mineMeta" style="margin-top:8px">Solved: 0 • Pending: 0 • Rewarded: 0 TCOIN</div>
    </section>

    <!-- Transfer -->
    <section class="card">
      <h2 style="margin:0 0 8px">Send / Receive</h2>
      <div class="meta" style="margin-bottom:10px">Add a friend by username, then send them TCOIN.</div>
      <div style="display:flex; flex-wrap:wrap; gap:8px">
        <input id="friend" placeholder="friend username" style="flex:1; min-width:220px; padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink)" />
        <input id="amount" type="number" min="0" step="0.0001" placeholder="amount" style="width:140px; padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink)"/>
        <button class="btn" id="sendBtn">Send</button>
      </div>
      <div class="meta" id="sendMsg" style="margin-top:8px"></div>
    </section>

    <!-- Packages -->
    <section class="card">
      <h2 style="margin:0 0 8px">Packages (gift codes)</h2>
      <div class="meta">Convert coins into a one-time “passid” gift code. Redeemable once.</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
        <input id="pkgAmt" type="number" min="0" step="0.0001" placeholder="amount to package" style="flex:1; min-width:220px; padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink)"/>
        <button class="btn" id="mkPkgBtn">Make Package</button>
      </div>
      <div class="meta" id="pkgOut" style="margin-top:8px"></div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
        <input id="redeemCode" placeholder="enter passid to redeem" style="flex:1; min-width:220px; padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink)"/>
        <button class="btn" id="redeemBtn">Redeem</button>
      </div>
      <div class="meta" id="redeemMsg" style="margin-top:8px"></div>
    </section>

    <footer><div>© 2025 ThreadlessCoin (demo)</div></footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
'use strict';

const TC = {
  SUPABASE_URL:  'https://vgdskvrovkekoxkixzsh.supabase.co', // <-- your project URL
  SUPABASE_ANON: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnZHNrdnJvdmtla294a2l4enNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NzIwOTYsImV4cCI6MjA3NDA0ODA5Nn0.e_wcEufQiUQpVwyAcshfOOdwf48gGzP8RiFOu5GYYmo',
  sb: null,
  me: { id:null, email:null, username:null, balance:0 }
};

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
function setStatus(s){ const el=$('status'); if(el) el.textContent=s; }
function showAuthUI(signedIn){ $('authArea').style.display = signedIn?'none':''; $('userArea').style.display = signedIn?'':''; }
function renderAccount(){
  $('userEmail').textContent = TC.me.email||'';
  $('userName').textContent  = TC.me.username||'—';
  $('balanceBadge').textContent = `Balance: ${Number(TC.me.balance||0).toFixed(4)} TCOIN`;
  $('usernameEditRow').style.display = TC.me.username ? 'none' : '';
}

/* ===== Theme (unchanged) ===== */
(function theme(){
  const sel = $('theme');
  const t = localStorage.getItem('threadless_theme') || 'forest';
  document.documentElement.setAttribute('data-theme', t);
  sel.value = t;
  sel.addEventListener('change', ()=>{ const v=sel.value; document.documentElement.setAttribute('data-theme', v); localStorage.setItem('threadless_theme', v); });
})();

/* ===== Error surfaces so you see what’s wrong instead of “connecting…” ===== */
window.addEventListener('error', (e)=>{ setStatus(`error: ${e.message||'script error'}`); });
window.addEventListener('unhandledrejection', (e)=>{ setStatus(`error: ${e.reason?.message||e.reason||'promise'}`); });

/* ===== Supabase helpers ===== */
async function pingSupabase(){
  try{
    // light, cached SELECT to prove CSP/keys/domain are correct
    const { error } = await TC.sb.from('profiles').select('id').limit(1);
    if (error) { setStatus(`db error: ${error.message}`); return false; }
    return true;
  }catch(err){
    setStatus(`db error: ${err?.message||err}`);
    return false;
  }
}

async function fetchProfile(){
  const { data, error } = await TC.sb
    .from('profiles').select('id,email,username,balance').eq('id', TC.me.id).maybeSingle();
  if (error) throw error;
  return data || null;
}
async function ensureProfile(){
  // auth trigger normally creates the row, but on first run it might lag
  for (let i=0;i<4;i++){
    const p = await fetchProfile(); if (p) return p;
    await new Promise(r=>setTimeout(r, 300));
  }
  await TC.sb.from('profiles').upsert({ id: TC.me.id, email: TC.me.email });
  return fetchProfile();
}

async function refreshUser(){
  try{
    // Fast path: local session
    const { data:sessionData } = await TC.sb.auth.getSession();
    if (sessionData?.session) {
      TC.me.id = sessionData.session.user.id;
      TC.me.email = sessionData.session.user.email || '';
    } else {
      // No session – we’re signed out
      showAuthUI(false);
      setStatus('signed out');
      return;
    }

    showAuthUI(true);
    setStatus('online');

    const p = await ensureProfile();
    if (p){ TC.me.username = p.username; TC.me.balance = p.balance||0; }
    renderAccount();
  }catch(err){
    setStatus(`auth error: ${err?.message||err}`);
  }
}

/* ===== Wire UI (same features, safer status updates) ===== */
function wireAuth(){
  $('signInBtn').addEventListener('click', async ()=>{
    const email = prompt('Enter your email for a magic sign-in link:'); if (!email) return;
    const redirectTo = new URL('./auth.html', location.href).href;
    const { error } = await TC.sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: redirectTo }});
    alert(error ? ('Failed: '+(error.message||'error')) : 'Check your email for the link!');
  });
  $('signOutBtn').addEventListener('click', async ()=>{ await TC.sb.auth.signOut(); location.reload(); });
  $('saveUserBtn').addEventListener('click', async ()=>{
    const v = ($('usernameInput').value||'').trim().toLowerCase();
    if (!/^[a-z0-9_]{3,20}$/.test(v)){ $('userMsg').textContent='3–20 chars: a-z, 0–9, _'; return; }
    $('userMsg').textContent='saving…';
    const { data, error } = await TC.sb.rpc('set_username', { p_username: v });
    if (error){ $('userMsg').textContent = error.message || 'failed'; return; }
    TC.me.username = data.username; $('userMsg').textContent='saved!'; renderAccount();
  });
  TC.sb.auth.onAuthStateChange(()=>refreshUser());
}

function wireMining(){
  const mineBtn=$('mineBtn'), stopBtn=$('stopBtn'), bar=$('miningProgress'), label=$('progressLabel'), meta=$('mineMeta');
  let running=false, solved=0, pending=0;
  const update=()=>meta.textContent=`Solved: ${solved} • Pending: ${pending} • Rewarded: ${Number(TC.me.balance||0).toFixed(4)} TCOIN`;

  async function reward(amt){
    const { data, error } = await TC.sb.rpc('reward_mine', { p_amount: amt });
    if (error) throw error;
    TC.me.balance = data||TC.me.balance; renderAccount();
  }
  async function loop(){
    running=true; bar.value=0; label.textContent='Working…'; pending++;
    for (let i=0;i<=100 && running;i++){ bar.value=i; await new Promise(r=>setTimeout(r,35)); }
    if (!running){ label.textContent='Stopped'; pending=Math.max(0,pending-1); update(); return; }
    try{ await reward(0.1); solved++; label.textContent='Proof found! +0.1 TCOIN'; }
    catch(e){ label.textContent='Reward failed: '+(e?.message||'error'); console.error(e); }
    finally{ pending=Math.max(0,pending-1); update(); }
    if (running) setTimeout(()=>loop(), 600);
  }
  mineBtn.addEventListener('click', ()=>{ if(!TC.me.id){alert('Sign in first.');return;} if(running)return; running=true; mineBtn.disabled=true; stopBtn.disabled=false; update(); loop(); });
  stopBtn.addEventListener('click', ()=>{ running=false; mineBtn.disabled=false; stopBtn.disabled=true; label.textContent='Idle'; });
  update();
}

function wireWallet(){
  const friend=$('friend'), amount=$('amount'), sendBtn=$('sendBtn'), sendMsg=$('sendMsg');
  const pkgAmt=$('pkgAmt'), mkPkgBtn=$('mkPkgBtn'), pkgOut=$('pkgOut');
  const redeemCode=$('redeemCode'), redeemBtn=$('redeemBtn'), redeemMsg=$('redeemMsg');

  sendBtn.addEventListener('click', async ()=>{
    if(!TC.me.id){alert('Sign in first.');return;}
    const to=(friend.value||'').trim().toLowerCase(); const amt=Number(amount.value||0);
    if(!to || !(amt>0)){ sendMsg.textContent='Enter friend username and amount.'; return; }
    sendMsg.textContent='Sending…';
    const { data, error } = await TC.sb.rpc('send_tcoin', { p_to_username: to, p_amount: amt });
    if (error){ sendMsg.textContent = error.message || 'failed'; return; }
    TC.me.balance = data||TC.me.balance; renderAccount(); sendMsg.textContent=`Sent ${amt} TCOIN to @${to}.`; amount.value='';
  });

  mkPkgBtn.addEventListener('click', async ()=>{
    if(!TC.me.id){alert('Sign in first.');return;}
    const v=Number(pkgAmt.value||0); if(!(v>0)){ pkgOut.textContent='Enter an amount.'; return; }
    pkgOut.textContent='Creating…';
    const { data, error } = await TC.sb.rpc('make_package', { p_amount: v });
    if (error){ pkgOut.textContent = error.message || 'failed'; return; }
    const row=(data&&data[0])||null;
    if(row){ pkgOut.textContent=`Created package for ${row.amount} TCOIN — passid: ${row.code}`; pkgAmt.value=''; TC.me.balance -= v; renderAccount(); }
    else{ pkgOut.textContent='Unexpected response.'; }
  });

  redeemBtn.addEventListener('click', async ()=>{
    if(!TC.me.id){alert('Sign in first.');return;}
    const code=(redeemCode.value||'').trim(); if(!code){ redeemMsg.textContent='Enter a passid.'; return; }
    redeemMsg.textContent='Redeeming…';
    const { data, error } = await TC.sb.rpc('redeem_package', { p_code: code });
    if (error){ redeemMsg.textContent = error.message || 'failed'; return; }
    TC.me.balance = data||TC.me.balance; renderAccount(); redeemMsg.textContent='Redeemed!'; redeemCode.value='';
  });
}

/* ===== Boot with explicit probe ===== */
(async function boot(){
  try{
    setStatus('connecting…');
    TC.sb = supabase.createClient(TC.SUPABASE_URL, TC.SUPABASE_ANON);
    wireAuth(); wireMining(); wireWallet();

    const ok = await pingSupabase();
    if (!ok) return; // status already set to error by ping

    await refreshUser(); // will set 'online' or 'signed out'
  }catch(err){
    setStatus(`boot error: ${err?.message||err}`);
  }
})();
</script>
</body>
</html>
