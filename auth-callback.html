<!doctype html>
<html lang="en" data-theme="forest">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ThreadlessCoin Â· Auth</title>
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  img-src 'self' data:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' https://cdn.jsdelivr.net;
  connect-src 'self' https://*.supabase.co wss://*.supabase.co;">
<style>
:root{ --bg:#0e1613; --card:#122019; --ink:#e9f5ee; --muted:#9db7ab; --line:#1e2e27; --accent:#ff8b3d; --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; --btn-ink:#28150a }
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 var(--font);display:grid;place-items:center;min-height:100vh}
.box{max-width:560px;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px; text-align:center}
button{margin-top:10px;border:0;border-radius:12px;padding:10px 14px;background:linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 75%, #000 25%));color:var(--btn-ink);font-weight:800;cursor:pointer}
small{color:var(--muted)}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
<script defer src="env.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(location.hash.slice(1) || location.search.slice(1));
  const error = params.get('error') || params.get('error_description');
  const type = params.get('type'); // e.g., 'signup'
  const box = document.getElementById('box');
  const home = location.origin + location.pathname.replace(/\/[^/]*$/, '/') + 'index.html';

  if (error){
    box.innerHTML = `<h2>Something went wrong</h2><p>${decodeURIComponent(error)}</p><button onclick="location.href='${home}'">Back to app</button>`;
    return;
  }

  // Optional: if Supabase ever sends a session (e.g., magic link), try to set it.
  try{
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV;
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // Some flows include 'access_token' in the fragment. If present, set the session.
    const access_token = params.get('access_token');
    const refresh_token = params.get('refresh_token');
    if (access_token && refresh_token){
      await sb.auth.setSession({ access_token, refresh_token });
    }
  }catch{}

  box.innerHTML = `
    <h2>Success! Account made ðŸŽ‰</h2>
    <p>Your email is confirmed${type ? ` (<code>${type}</code>)` : ''}. You can now sign in and start using ThreadlessCoin.</p>
    <button onclick="location.href='${home}'">Continue to ThreadlessCoin</button>
    <p><small>If the app doesnâ€™t show you as signed in, just log in with your email & password.</small></p>
  `;
});
</script>
</head>
<body><div id="box" class="box">Checkingâ€¦</div></body>
</html>
